<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bekefendi Studio Pro - Auto Artwork</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <style>
        /* --- TEMEL AYARLAR --- */
        * { box-sizing: border-box; }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- ARKA PLAN --- */
        #bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #120524, #2a0e45, #15082b);
            background-size: cover;
            background-position: center;
            filter: blur(40px) brightness(0.5);
            z-index: -10;
            transition: filter 0.08s ease-out, background-image 0.5s ease; /* Resim değişimi için yumuşak geçiş */
        }

        .main-container {
            display: flex;
            gap: 20px;
            align-items: stretch;
            height: 85vh;
            width: 90vw;
            max-width: 1400px;
        }

        /* --- SOL PANEL --- */
        .visualizer-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 25px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        #canvas-visualizer {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- ŞARKI BİLGİSİ --- */
        .info-wrapper {
            position: absolute;
            top: 72%;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 15;
            pointer-events: none;
            padding: 0 20px;
        }
        .track-title {
            font-size: 1.6rem; font-weight: 800; color: #fff; margin: 0;
            text-shadow: 0 0 10px rgba(213, 0, 249, 0.5);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-artist {
            font-size: 0.9rem; font-weight: 400; color: #ccc; margin-top: 5px;
            letter-spacing: 2px; text-transform: uppercase;
        }

        /* --- KONTROLLER --- */
        .controls-wrapper {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; z-index: 20; pointer-events: none;
        }
        .live-btn {
            pointer-events: auto; 
            background: linear-gradient(90deg, #7b1fa2 0%, #4a148c 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(123, 31, 162, 0.4);
            display: inline-flex; align-items: center; gap: 10px; transition: all 0.2s;
        }
        .live-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(123, 31, 162, 0.6); }
        .hint {
            margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.4);
            pointer-events: auto; background: rgba(0,0,0,0.5);
            display: inline-block; padding: 5px 10px; border-radius: 10px;
        }

        /* --- SAĞ PANEL --- */
        .sc-panel {
            flex: 1; background: rgba(10, 10, 10, 0.9); border-radius: 25px;
            overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; flex-direction: column;
        }
        #sc-frame { width: 100%; height: 100%; border: none; }
        #file-upload { display: none; }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="main-container">
        <div class="visualizer-panel" id="viz-panel" onclick="triggerUpload(event)">
            <canvas id="canvas-visualizer"></canvas>
            <input type="file" id="file-upload" accept="image/*">
            
            <div class="info-wrapper">
                <h2 class="track-title" id="track-title">BEKEFENDI STUDIO</h2>
                <p class="track-artist" id="track-artist">Ready to play</p>
            </div>

            <div class="controls-wrapper">
                <button class="live-btn" id="start-capture-btn">
                    <i class="fa-solid fa-power-off"></i> SİSTEMİ BAŞLAT
                </button>
                <div class="hint">
                    <i class="fa-solid fa-triangle-exclamation"></i> <b>"Bu Sekme (This Tab)"</b> seç ve <b>"Sesi Paylaş"</b>ı işaretle.
                </div>
            </div>
        </div>

        <div class="sc-panel">
            <iframe id="sc-frame" 
                    scrolling="auto" frameborder="no" allow="autoplay" 
                    src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/bekefendi&color=%237b1fa2&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=false">
            </iframe>
        </div>
    </div>

    <script>
        const fileUpload = document.getElementById('file-upload');
        const canvas = document.getElementById('canvas-visualizer');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-capture-btn');
        const bgLayer = document.getElementById('bg-layer');
        const vizPanel = document.getElementById('viz-panel');
        const titleEl = document.getElementById('track-title');
        const artistEl = document.getElementById('track-artist');

        let audioContext, analyser, isRunning = false;
        let rotationAngle = 0;
        
        // --- İŞTE ÇÖZÜM: BASE64 VARSAYILAN RESİM ---
        // Bu resim kodun içinde gömülü olduğu için anında yüklenir. Bekleme yok.
        const defaultImageBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="; // Siyah bir piksel
        
        let recordImg = new Image();
        recordImg.crossOrigin = "anonymous"; // SoundCloud'dan gelen resimler için gerekli
        // Başlangıçta hemen hazır olması için base64 kullanıyoruz
        recordImg.src = defaultImageBase64; 
        
        // İlk açılışta görseli çiz
        recordImg.onload = () => { if(!isRunning) drawStatic(); };

        // --- SOUNDCLOUD API & KAPAK ÇEKME ---
        var iframeElement = document.querySelector('#sc-frame');
        var widget = SC.Widget(iframeElement);

        widget.bind(SC.Widget.Events.READY, function() {
            widget.bind(SC.Widget.Events.PLAY, updateTrackInfo);
            widget.bind(SC.Widget.Events.FINISH, () => setTimeout(updateTrackInfo, 1000));
        });

        function updateTrackInfo() {
            widget.getCurrentSound(function(sound) {
                if (sound) {
                    titleEl.innerText = sound.title;
                    artistEl.innerText = sound.user.username;
                    
                    // --- KAPAK RESMİ ENTEGRASYONU ---
                    if(sound.artwork_url) {
                        // SoundCloud küçük resim veriyor, onu yüksek çözünürlüklü yapıyoruz
                        const highResUrl = sound.artwork_url.replace('-large', '-t500x500');
                        
                        // Plağın göbeğindeki resmi güncelle
                        recordImg.src = highResUrl;
                        
                        // Arka planı da güncelle (isteğe bağlı, çok şık durur)
                        bgLayer.style.backgroundImage = `url('${highResUrl}')`;
                    } else {
                        // Kapak yoksa varsayılanı kullan
                        recordImg.src = defaultImageBase64;
                    }
                }
            });
        }

        // --- BOYUTLANDIRMA ---
        function resizeCanvas() {
            canvas.width = vizPanel.offsetWidth;
            canvas.height = vizPanel.offsetHeight;
            if(!isRunning) drawStatic();
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        // --- MANUEL RESİM YÜKLEME (Hala çalışıyor) ---
        function triggerUpload(event) {
            if(event.target.closest('.live-btn')) return;
            fileUpload.click();
        }
        fileUpload.onchange = function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    recordImg.src = e.target.result;
                    bgLayer.style.backgroundImage = `url('${e.target.result}')`;
                }
                reader.readAsDataURL(file);
            }
        };

        // --- SİSTEMİ BAŞLAT ---
        startBtn.onclick = async function() {
            if (isRunning) return;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true, 
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }, 
                    selfBrowserSurface: "include", systemAudio: "include" 
                });

                if (stream.getAudioTracks().length === 0) {
                    stream.getTracks().forEach(track => track.stop());
                    alert("HATA: 'Sesi Paylaş' kutucuğunu işaretlemedin!");
                    return;
                }

                startBtn.innerHTML = '<i class="fa-solid fa-waveform"></i> SİSTEM AKTİF';
                startBtn.style.background = "#222"; 
                isRunning = true;
                stream.getTracks()[0].onended = () => { stopSystem(); };
                resizeCanvas();
                setupAudioAnalysis(stream);

            } catch (err) { if (err.name !== 'NotAllowedError') alert("Hata: " + err.message); }
        };

        function stopSystem() {
            isRunning = false;
            startBtn.innerHTML = '<i class="fa-solid fa-power-off"></i> SİSTEMİ BAŞLAT';
            startBtn.style.background = "linear-gradient(90deg, #7b1fa2 0%, #4a148c 100%)";
            bgLayer.style.filter = 'blur(40px) brightness(0.5)';
            if(audioContext) audioContext.close();
            drawStatic();
        }

        function setupAudioAnalysis(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.8;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function animate() {
                if (!isRunning) return;
                requestAnimationFrame(animate);
                analyser.getByteFrequencyData(dataArray);
                
                let bassSum = 0;
                let bassRange = Math.floor(bufferLength * 0.3); 
                for (let i = 0; i < bassRange; i++) { bassSum += dataArray[i]; }
                let bassAvg = bassSum / bassRange; 
                
                let brightness = 0.5 + (bassAvg / 255) * 1.5;
                let hueRotate = (bassAvg / 1.5);
                bgLayer.style.filter = `blur(40px) brightness(${brightness}) hue-rotate(${hueRotate}deg)`;

                drawFrame(dataArray, true);
            }
            animate();
        }

        function drawFrame(dataArray, isAnimating) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 160;

            // Visualizer
            if (dataArray) {
                const bufferLength = dataArray.length;
                for (let i = 0; i < bufferLength; i++) {
                    const value = dataArray[i];
                    if (value < 10) continue; 
                    const barHeight = (value * 0.9) + 5;
                    const angle = (i * 2 * Math.PI) / bufferLength;
                    const xStart = centerX + Math.cos(angle) * radius;
                    const yStart = centerY + Math.sin(angle) * radius;
                    const xEnd = centerX + Math.cos(angle) * (radius + barHeight);
                    const yEnd = centerY + Math.sin(angle) * (radius + barHeight);
                    const gradient = ctx.createLinearGradient(xStart, yStart, xEnd, yEnd);
                    gradient.addColorStop(0, '#d500f9'); gradient.addColorStop(1, '#00e5ff');
                    ctx.beginPath(); ctx.moveTo(xStart, yStart); ctx.lineTo(xEnd, yEnd);
                    ctx.strokeStyle = gradient; ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.stroke();
                }
            }

            // Plak ve Resim
            ctx.save();
            ctx.translate(centerX, centerY);
            if (isAnimating) rotationAngle += 0.01;
            ctx.rotate(rotationAngle);

            // Resmi maskele ve çiz
            ctx.beginPath(); ctx.arc(0, 0, 150, 0, Math.PI * 2); ctx.closePath(); ctx.clip();
            
            // GÜVENLİK KONTROLÜ: Resim yüklü değilse çizme, yüklüyse çiz.
            if (recordImg.complete && recordImg.naturalWidth > 0) {
                 ctx.drawImage(recordImg, -150, -150, 300, 300);
            } else {
                 // Resim yoksa siyah dolgu yap
                 ctx.fillStyle = "#000"; ctx.fill();
            }
           
            // Plak detayları
            ctx.beginPath(); ctx.arc(0, 0, 150, 0, Math.PI * 2); ctx.lineWidth = 15; ctx.strokeStyle = "#111"; ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI * 2); ctx.fillStyle = "#000"; ctx.fill();
            ctx.restore();
        }

        function drawStatic() { drawFrame(null, false); }
    </script>
</body>
</html>