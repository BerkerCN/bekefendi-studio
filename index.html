<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bekefendi Studio Pro - Visual Experience</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- YENÄ°: Faviconlar -->
    <link id="favicon-default" rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”®</text></svg>">
    <link id="favicon-playing" rel="alternate icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¶</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <!-- 3D MODU Ä°Ã‡Ä°N THREE.JS KÃœTÃœPHANESÄ° -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* --- TEMEL AYARLAR --- */
        /* YENÄ°: Ã–zel KaydÄ±rma Ã‡ubuÄŸu */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; /* DÃœZELTME: Body'nin arka plan rengini kaldÄ±rarak alttaki katmanlarÄ±n gÃ¶rÃ¼nmesini saÄŸla */
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- YENÄ°: VIGNETTE VE GRID EFEKTLERÄ° --- */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -7; /* Grid'in Ã¼zerinde olmasÄ± iÃ§in */
            display: none; /* DÃœZELTME: Kenar karartma/parlama efektini tamamen kaldÄ±r */
        }
        /* YENÄ°: Fareyi takip eden Ä±ÅŸÄ±k efekti */
        #mouse-spotlight {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -8; /* Grid'in arkasÄ±nda, ana arka planÄ±n Ã¶nÃ¼nde */
            background: radial-gradient(circle 600px at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(120, 80, 200, 0.15), transparent 80%);
            pointer-events: none;
            transition: background 0.2s ease-out; /* YumuÅŸak takip */
        }

        #grid-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -9;
            pointer-events: none;
        }

        /* --- GÄ°RÄ°Åž ANÄ°MASYONU --- */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ARKA PLAN --- */
        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #02010a, #0a071c, #02010a, #100c24);
            background-size: 300% 300%;
            filter: blur(40px) brightness(0.3); /* DÃœZELTME: Gece modu iÃ§in parlaklÄ±ÄŸÄ± daha da dÃ¼ÅŸÃ¼r */ z-index: -10;
            transition: filter 0.5s ease-out;
            animation: animatedGradient 40s ease infinite; /* Animasyonu yavaÅŸlat */
        }
        @keyframes animatedGradient {
            0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
        }
        #bg-layer::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -8;
            background-size: cover; background-position: center;
            opacity: 0; /* BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nmez */
            transition: opacity 1.5s ease-in-out; /* YavaÅŸ ve yumuÅŸak geÃ§iÅŸ */
        }
        
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -5; pointer-events: none;
            transition: opacity 0.5s; /* DÃœZELTME: ParÃ§acÄ±k efektini geri getir */
        }

        .main-container {
            display: flex; gap: 20px; align-items: stretch;
            height: 85vh; width: 90vw; max-width: 1400px;
            animation: fadeInSlideUp 0.8s ease-out forwards;
        }

        /* --- SOL PANEL --- */
        .visualizer-panel {
            flex: 2; /* Daha fazla yer kaplamasÄ± iÃ§in flex deÄŸerini artÄ±r */ background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(30px); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 25px; /* DÃœZELTME: Kenar parlamasÄ±nÄ± kaldÄ±rmak iÃ§in gÃ¶lgeyi devre dÄ±ÅŸÄ± bÄ±rak */
            position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
        }

        /* --- KONTROL Ä°KONLARI --- */
        .icon-controls {
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 25;
            display: flex;
            gap: 5px;
        }
        /* YENÄ°: Sinema modu iÃ§in geÃ§iÅŸ */
        .icon-controls, .sc-tabs {
            transition: opacity 0.5s ease-in-out;
        }
        .control-btn {
            cursor: pointer; color: rgba(255,255,255,0.4);
            font-size: 1.1rem; transition: all 0.2s ease;
            padding: 10px; border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        /* YENÄ°: Buton tÄ±klama animasyonu */
        .control-btn:active {
            transform: scale(0.9) !important; /* Hover'Ä± ezer */
            transition: transform 0.05s ease;
        }
        .control-btn:hover { color: rgba(255,255,255,0.9); transform: scale(1.1); background: rgba(0,0,0,0.2); }

        /* --- AYARLAR PANELÄ° --- */
        #settings-panel { /* DÃœZELTME: Mobil iÃ§in de kullanÄ±lacak */
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            z-index: 100;
            width: 280px;
            color: #eee;
            visibility: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
        }
        #settings-panel.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #aaa; }
        .setting-item input[type="range"] { width: 100%; }
        .toggle-switch { display: flex; justify-content: space-between; align-items: center; }
        /* Basit bir toggle switch stili */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #d500f9; }
        input:checked + .slider:before { transform: translateX(20px); }


        #canvas-visualizer, #canvas-3d {
            position: absolute; top: 0; left: 0;
            display: block; width: 100%; height: 100%; 
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out, filter 0.4s ease-in-out; /* YENÄ°: GeliÅŸmiÅŸ geÃ§iÅŸ */
        }

        /* --- ÅžARKI BÄ°LGÄ°SÄ° --- */
        .info-wrapper {
            position: absolute;
            top: 65px; /* DÃœZELTME: Kontrol butonlarÄ±nÄ±n altÄ±na konumlandÄ±r */
            left: 20px; /* DÃœZELTME: Kontrol butonlarÄ±yla aynÄ± hizada baÅŸlat */
            width: auto; max-width: 350px; /* GeniÅŸliÄŸi ayarla */
            z-index: 15; pointer-events: none;
        }
        .track-title {
            font-size: 1.8rem; font-weight: 800; color: #fff; margin: 0; /* DÃœZELTME: Boyutu kÃ¼Ã§Ã¼lt */
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(213, 0, 249, 0.5);
            white-space: nowrap; overflow: hidden;
            transition: text-shadow 0.1s ease-out;
        }
        .track-title.scrolling > span {
            display: inline-block; padding-left: 100%;
            animation: marquee 10s linear infinite; /* DÃœZELTME: KaydÄ±rma hÄ±zÄ±nÄ± artÄ±r */
        }
        @keyframes marquee {
            0%   { transform: translateX(0); } 100% { transform: translateX(-100%); }
        }
        .track-title > span { display: inline-block; }
        .track-artist {
            font-size: 1rem; font-weight: 400; color: rgba(255,255,255,0.7); margin-top: 10px;
            letter-spacing: 1px; text-transform: uppercase; /* DÃœZELTME: Harf aralÄ±ÄŸÄ±nÄ± azalt */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: text-shadow 0.1s ease-out;
        }

        /* YENÄ°: ÅžARKI KONTROLLERÄ° */
        .playback-controls {
            position: absolute;
            top: 15px; /* DÃœZELTME: SaÄŸdaki ikonlarla aynÄ± hizada, Ã¼stte konumlandÄ±r */
            left: 20px; /* DÃœZELTME: Sol kÃ¶ÅŸeye yerleÅŸtir */
            z-index: 22;
            display: flex;
            gap: 5px; /* DÃœZELTME: DiÄŸer ikonlarla aynÄ± boÅŸluk deÄŸeri */
            align-items: center;
            transition: opacity 0.5s ease-in-out; /* Sinema modu iÃ§in */
        }
        .playback-btn.play-btn { /* Oynat butonu daha bÃ¼yÃ¼k */
            /* DÃœZELTME: DiÄŸer butonlarla aynÄ± boyutta olsun */
            width: 40px; height: 40px;
            font-size: 1.1rem;
        }
        /* YENÄ°: Ses KontrolÃ¼ */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px; /* DÃœZELTME: Butonlardan biraz ayÄ±r */
        }
        .volume-control .control-btn {
            width: 35px; height: 35px; font-size: 1rem;
        }
        #volume-slider {
            width: 80px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(0,0,0,0.3);
            height: 4px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* --- KONTROLLER --- */
        .controls-wrapper {
            position: absolute; bottom: 30px; right: 30px;
            width: auto;
            text-align: right; z-index: 20;
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1); /* YENÄ°: YumuÅŸak geÃ§iÅŸ animasyonu */
        }
        /* YENÄ°: CanlÄ± mod aktifken butonun sol alta geÃ§mesini saÄŸlayan stil */
        .controls-wrapper.live-active {
            right: auto;
            left: 30px;
        }

        .live-btn {
            pointer-events: auto; background: linear-gradient(90deg, #7b1fa2 0%, #4a148c 100%);
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(123, 31, 162, 0.4);
            display: inline-flex; align-items: center; gap: 10px; transition: all 0.2s;
        }
        .live-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(123, 31, 162, 0.6); }
        /* YENÄ°: CanlÄ± modda nabÄ±z efekti */
        .live-btn.pulsating-live {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(211, 47, 47, 0.4); }
            50% { box-shadow: 0 0 35px rgba(211, 47, 47, 0.8); }
        }

        .hint {
            margin-top: 10px; font-size: 0.8rem; color: rgba(255,255,255,0.4);
            pointer-events: auto; background: rgba(0,0,0,0.5);
            display: inline-block; padding: 5px 10px; border-radius: 10px;
        }
        .explanation-text {
            margin-top: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.5);
            max-width: 350px; /* GeniÅŸliÄŸin Ã§ok artmasÄ±nÄ± Ã¶nle */
            margin-left: auto; margin-right: auto;
            line-height: 1.4;
        }
        /* YENÄ°: AkÄ±llÄ± ipucu iÃ§in gizleme stili */
        .hint.hidden, .explanation-text.hidden {
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0; transform: translateY(-10px); pointer-events: none;
        }

        /* --- SAÄž PANEL --- */
        .sc-panel {
            flex: 0 0 380px; max-width: 380px;
            background: rgba(255, 255, 255, 0.05); /* YarÄ± saydam beyaz arka plan */
            backdrop-filter: blur(30px); /* Arkadaki iÃ§eriÄŸi bulanÄ±klaÅŸtÄ±r */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Ä°nce, parlak bir kenarlÄ±k */
            border-radius: 25px; overflow: hidden;
            display: flex; flex-direction: column;
            /* DÃœZELTME: Kenar parlamasÄ±nÄ± kaldÄ±rmak iÃ§in gÃ¶lgeyi devre dÄ±ÅŸÄ± bÄ±rak */
        }
        /* YENÄ°: Sekme ButonlarÄ± */
        .sc-tabs { display: flex; padding: 10px; background: rgba(0,0,0,0.2); }
        .sc-tab-btn {
            flex: 1; text-align: center; padding: 10px;
            color: rgba(255,255,255,0.5); background: transparent;
            border: none; border-radius: 15px; cursor: pointer;
            font-family: 'Inter', sans-serif; font-weight: 600;
            transition: all 0.3s ease;
        }
        .sc-tab-btn.active { color: #fff; background: rgba(255,255,255,0.1); }
        /* YENÄ°: Buton tÄ±klama animasyonu */
        .sc-tab-btn:active {
            transform: scale(0.95);
            transition: transform 0.05s ease;
        }
        .sc-tab-btn:hover:not(.active) { background: rgba(255,255,255,0.05); }

        /* YENÄ°: iframe'leri tutan konteyner */
        .sc-content { flex-grow: 1; position: relative; }

        #sc-frame { 
            width: 100%; height: 100%; border: none; 
            transition: opacity 0.4s ease-in-out; /* YENÄ°: YumuÅŸak geÃ§iÅŸ */
        }
        /* YENÄ°: Ä°kinci iframe (Top Listesi) */
        #sc-topsongs-frame {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; border: none;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        #file-upload { display: none; }

        /* --- MOBÄ°L UYUMLULUK --- */
        @media (max-width: 768px) {
            body, html { overflow: auto; align-items: flex-start; }
            .main-container { flex-direction: column; height: auto; width: 100%; padding: 15px; gap: 15px; }
            .visualizer-panel { flex: 0 0 300px; cursor: default; }
            .sc-panel { flex: 1; min-height: 400px; }
            .info-wrapper { top: 65%; }
            .track-title { font-size: 1.5rem; }
            .track-artist { font-size: 0.8rem; }
            .controls-wrapper, #settings-panel { display: none; } /* AyarlarÄ± mobilde gizle */
        }

        /* YENÄ°: Telefonlar iÃ§in Ã¶zel iyileÅŸtirmeler */
        @media (max-width: 480px) {
            .visualizer-panel { flex: 0 0 250px; } /* GÃ¶rselleÅŸtirici yÃ¼ksekliÄŸini azalt */
            .sc-panel { min-height: 450px; } /* DÃœZELTME: SC paneli yÃ¼ksekliÄŸini ayarla */
            .track-title { font-size: 1.2rem; }
            .track-artist { font-size: 0.7rem; }
            .info-wrapper { top: 50%; } /* BaÅŸlÄ±ÄŸÄ± ortala */
            .sc-tabs {
                padding: 5px; /* Sekme alanÄ±nÄ± kÃ¼Ã§Ã¼lt */
            }
            .controls-wrapper { /* Kontrolleri tekrar gÃ¶rÃ¼nÃ¼r yap ve ortaya al */
                display: block;
                bottom: 15px;
            }
            .icon-controls { /* Ä°konlarÄ± altta, ortada gÃ¶ster */
                top: auto; bottom: 70px; left: 50%; transform: translateX(-50%);
                background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px;
            }
            #settings-panel { display: block; } /* Ayarlar panelini tekrar aktif et */
        }

        /* --- YÃœKLEME EKRANI --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 9999; display: flex;
            justify-content: center; align-items: center;
            transition: opacity 0.7s ease, visibility 0.7s ease;
            opacity: 1; visibility: visible;
            flex-direction: column; /* YENÄ°: Metin iÃ§in */
        }
        /* YENÄ°: YÃ¼kleme ekranÄ± metni */
        #loading-text {
            margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 0.9rem;
        }
        #loader.hidden { opacity: 0; visibility: hidden; }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: #d500f9; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        /* YENÄ°: Sinema Modu (ArayÃ¼zÃ¼ gizleme) */
        body.cinema-mode .icon-controls,
        body.cinema-mode .sc-tabs,
        body.cinema-mode .playback-controls,
        body.cinema-mode .volume-control { /* YENÄ°: Ses kontrolÃ¼nÃ¼ de gizle */
            opacity: 0;
            pointer-events: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loading-text">Initializing...</div>
    </div>
    <canvas id="grid-canvas"></canvas>
    <div id="mouse-spotlight"></div>
    <canvas id="particle-canvas"></canvas>
    <div id="bg-layer"></div>

    <div class="main-container">

        <div class="visualizer-panel" id="viz-panel">
            <canvas id="canvas-visualizer"></canvas>
            <canvas id="canvas-3d"></canvas>

            <div class="icon-controls">
                <div id="settings-btn" class="control-btn" title="Ayarlar">
                    <i class="fa-solid fa-gear"></i>
                </div>
                <div id="artist-switcher" class="control-btn" title="SanatÃ§Ä±yÄ± DeÄŸiÅŸtir">
                    <i class="fa-solid fa-right-left"></i>
                </div>
                <div id="style-switcher" class="control-btn" title="GÃ¶rselleÅŸtirici Stilini DeÄŸiÅŸtir">
                    <i class="fa-solid fa-circle-notch"></i>
                </div>
            </div>

            <div id="settings-panel">
                <div class="setting-item">
                    <label for="effect-intensity">Efekt YoÄŸunluÄŸu</label>
                    <input type="range" id="effect-intensity" min="0" max="2" value="1" step="0.1">
                </div>
                <div class="setting-item">
                    <label for="bg-blur">Arka Plan BulanÄ±klÄ±ÄŸÄ±</label>
                    <input type="range" id="bg-blur" min="0" max="80" value="25" step="1">
                </div>
                <div class="setting-item">
                    <div class="toggle-switch">
                        <label for="particle-toggle">ParÃ§acÄ±k Efekti</label>
                        <label class="switch">
                            <input type="checkbox" id="particle-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="info-wrapper">
                <h2 class="track-title" id="track-title"><span>BEKEFENDI STUDIO</span></h2>
                <p class="track-artist" id="track-artist">Ready to play</p>
            </div>

            <!-- YENÄ°: ÅžARKI KONTROLLERÄ° -->
            <div id="playback-controls" class="playback-controls">
                <div id="prev-btn" class="control-btn playback-btn" title="Ã–nceki ÅžarkÄ±">
                    <i class="fa-solid fa-backward-step"></i>
                </div>
                <div id="play-pause-btn" class="control-btn playback-btn play-btn" title="Oynat/Durdur (BoÅŸluk)">
                    <i class="fa-solid fa-play"></i>
                </div>
                <div id="next-btn" class="control-btn playback-btn" title="Sonraki ÅžarkÄ±">
                    <i class="fa-solid fa-forward-step"></i>
                </div>
                <!-- YENÄ°: SES KONTROLÃœ -->
                <div class="volume-control">
                    <div id="volume-btn" class="control-btn playback-btn" title="Sesi Kapat/AÃ§">
                        <i class="fa-solid fa-volume-high"></i>
                    </div>
                    <input type="range" id="volume-slider" min="0" max="100" value="80" title="Ses Seviyesi">
                </div>
            </div>

            <div class="controls-wrapper">
                <button class="live-btn" id="start-btn">
                    <i class="fa-solid fa-broadcast-tower"></i> CANLI SENKRONÄ°ZASYONU BAÅžLAT
                </button>
                <div class="hint">
                    <i class="fa-solid fa-triangle-exclamation"></i> <b>"Bu Sekme (This Tab)"</b> seÃ§ ve <b>"Sesi PaylaÅŸ"</b>Ä± iÅŸaretle.
                </div>
                <div class="explanation-text">
                    Bu mod, gÃ¶rsel efektlerin Ã§alan mÃ¼ziÄŸe gerÃ§ek zamanlÄ± tepki vermesini saÄŸlar. (Daha yÃ¼ksek sistem kaynaÄŸÄ± gerektirebilir)
                </div>
            </div>
        </div>

        <div class="sc-panel">
            <div class="sc-tabs">
                <button id="tab-profile" class="sc-tab-btn active">Profil</button>
                <button id="tab-topsongs" class="sc-tab-btn">Remixler</button>
            </div>
            <div class="sc-content">
                <iframe id="sc-frame" 
                        scrolling="auto" frameborder="no" allow="autoplay" 
                        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/bekefendi&color=%237b1fa2&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=false">
                </iframe>
                <iframe id="sc-topsongs-frame"
                        scrolling="auto" frameborder="no" allow="autoplay"
                        src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/bekefendi/sets/top-remixes-by-bekefendi&color=%237b1fa2&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=false">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTLERÄ° (DÄ°NAMÄ°K OLANLAR HARÄ°Ã‡) ---
        const loader = document.getElementById('loader');
        const canvas = document.getElementById('canvas-visualizer');
        const ctx = canvas.getContext('2d');
        const canvas3D = document.getElementById('canvas-3d');
        const gridCanvas = document.getElementById('grid-canvas');
        const gCtx = gridCanvas.getContext('2d');
        const particleCanvas = document.getElementById('particle-canvas');
        const pCtx = particleCanvas.getContext('2d'); 
        const startBtn = document.getElementById('start-btn');
        const bgLayer = document.getElementById('bg-layer');
        const vizPanel = document.getElementById('viz-panel');
        const titleEl = document.getElementById('track-title');
        const styleSwitcher = document.getElementById('style-switcher');
        const artistSwitcher = document.getElementById('artist-switcher');
        const artistEl = document.getElementById('track-artist');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const effectIntensitySlider = document.getElementById('effect-intensity');
        const bgBlurSlider = document.getElementById('bg-blur');
        const particleToggle = document.getElementById('particle-toggle');
        // YENÄ°: SoundCloud Sekme Elementleri
        const hintText = document.querySelector('.hint');
        const explanationText = document.querySelector('.explanation-text');
        const scTopSongsFrame = document.getElementById('sc-topsongs-frame');
        // YENÄ°: ÅžarkÄ± Kontrol ButonlarÄ±
        const prevBtn = document.getElementById('prev-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const nextBtn = document.getElementById('next-btn');
        // YENÄ°: Ses KontrolÃ¼ Elementleri
        const volumeBtn = document.getElementById('volume-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const tabProfile = document.getElementById('tab-profile');
        const tabTopSongs = document.getElementById('tab-topsongs');
 
        // --- DÄ°NAMÄ°K GLOBAL DEÄžÄ°ÅžKENLER ---
        // DÃœZELTME: Bu deÄŸiÅŸkenler sanatÃ§Ä± deÄŸiÅŸtirildiÄŸinde yeniden atanacak.
        let iframeElement;
        let widget;

        let audioContext, analyser;
        let currentMode = 'simulation'; // 'simulation' veya 'realtime'
        let isPlaying = false; // SoundCloud widget'Ä±nÄ±n durumunu takip eder
        let currentPalette = [[213, 0, 249], [0, 229, 255]];
        let targetPalette = [[213, 0, 249], [0, 229, 255]];
        let rotationAngle = 0;
        let simulationBeatInterval;
        let trackChangeInterval;
        // YENÄ°: Profesyonel detaylar iÃ§in deÄŸiÅŸkenler
        let cinemaModeTimeout;
        const cinemaModeDelay = 3000; // 3 saniye sonra sinema modu
        const originalTitle = document.title;
        const faviconDefault = document.getElementById('favicon-default');
        const faviconPlaying = document.getElementById('favicon-playing');

        // --- AYAR YÃ–NETÄ°MÄ° ---

        // --- AYARLAR (KULLANICI KONTROLLERÄ°) ---
        let settings = {
            effectIntensity: 1,
            backgroundBlur: 25,
            useParticles: true,
            volume: 80 // YENÄ°: Ses seviyesi iÃ§in varsayÄ±lan deÄŸer
        };

        // YENÄ°: AyarlarÄ± kaydetme ve yÃ¼kleme
        function saveSettings() {
            localStorage.setItem('bekefendiStudioSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('bekefendiStudioSettings');
            if (savedSettings) {
                // DÃœZELTME: Yeni ayarlar eklendiÄŸinde hata olmamasÄ± iÃ§in mevcut ayarlar Ã¼zerine yaz.
                Object.assign(settings, JSON.parse(savedSettings));

                // UI elemanlarÄ±nÄ± gÃ¼ncelle
                effectIntensitySlider.value = settings.effectIntensity;
                bgBlurSlider.value = settings.backgroundBlur;
                particleToggle.checked = settings.useParticles;
                // YENÄ°: KaydedilmiÅŸ ses seviyesini yÃ¼kle
                if (settings.volume !== undefined) {
                    volumeSlider.value = settings.volume;
                    updateVolumeIcon(settings.volume);
                }

                // AyarlarÄ± uygula
                particleCanvas.style.opacity = settings.useParticles ? '1' : '0';
                // DÃœZELTME: `bgLayer.style.filter` ayarÄ± mainLoop iÃ§inde dinamik olarak yapÄ±ldÄ±ÄŸÄ± iÃ§in buradan kaldÄ±rÄ±ldÄ±.
            }
        }

        // --- SANATÃ‡I VE STÄ°L YÃ–NETÄ°MÄ° ---
        const artists = [
            { name: 'Bekefendi', url: 'https://soundcloud.com/bekefendi' },
            { name: 'yxng_anxty', url: 'https://soundcloud.com/yxng_anxty' }
        ];
        let currentArtistIndex = 0;
        const visualizerStyles = [
            { name: 'circle', icon: 'fa-solid fa-circle-notch' },
            { name: 'line', icon: 'fa-solid fa-bars-staggered' },
            { name: 'mirror', icon: 'fa-solid fa-water' },
            { name: 'pulse', icon: 'fa-solid fa-bullseye' },
            { name: '3d-sphere', icon: 'fa-solid fa-globe' },
            { name: '3d-orb', icon: 'fa-solid fa-atom' } // YENÄ°: Enerji KÃ¼resi
        ];
        let currentStyleIndex = 0;
        
        // --- RESÄ°M YÃ–NETÄ°MÄ° ---
        const defaultImageBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=";
        let recordImg = new Image();
        recordImg.crossOrigin = "anonymous";
        recordImg.src = defaultImageBase64; 
        recordImg.onload = () => {
            try {
                const colorThief = new ColorThief();
                const newPalette = colorThief.getPalette(recordImg, 2);
                if (newPalette) targetPalette = newPalette;
                if (three.albumArtTexture) three.albumArtTexture.needsUpdate = true;
            } catch (e) {
                targetPalette = [[213, 0, 249], [0, 229, 255]];
            }
            // drawStatic Ã§aÄŸrÄ±sÄ± kaldÄ±rÄ±ldÄ±, mainLoop zaten sÃ¼rekli Ã§izim yapÄ±yor.
        };

        // --- SOUNDCLOUD WIDGET ---
        function initializeWidget() {
            widget = SC.Widget(iframeElement); // Global widget deÄŸiÅŸkenini ata
            widget.bind(SC.Widget.Events.READY, function() {
                // YÃ¼kleyiciyi gizle ve ana animasyon dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
                loader.classList.add('hidden');
                // DÃœZELTME: Yeni widget iÃ§in olaylarÄ± ve kontrolÃ¼ yeniden baÅŸlat
                widget.unbind(SC.Widget.Events.PLAY); widget.unbind(SC.Widget.Events.PAUSE); widget.unbind(SC.Widget.Events.FINISH);
                widget.bind(SC.Widget.Events.PLAY, () => {
                    isPlaying = true;
                    startSimulationBeat();
                    playPauseBtn.querySelector('i').className = 'fa-solid fa-pause'; // Ä°konu deÄŸiÅŸtir
                    updateTrackInfo(); // BaÅŸlÄ±k ve favicon'u hemen gÃ¼ncelle
                });
                widget.bind(SC.Widget.Events.PAUSE, () => {
                    isPlaying = false;
                    stopSimulationBeat();
                    // YENÄ°: BaÅŸlÄ±ÄŸÄ± ve favicon'u sÄ±fÄ±rla
                    playPauseBtn.querySelector('i').className = 'fa-solid fa-play'; // Ä°konu deÄŸiÅŸtir
                    document.title = originalTitle;
                    faviconPlaying.remove();
                    document.head.appendChild(faviconDefault);
                });
                widget.bind(SC.Widget.Events.FINISH, () => {
                    setTimeout(updateTrackInfo, 1000);
                    // YENÄ°: BaÅŸlÄ±ÄŸÄ± ve favicon'u sÄ±fÄ±rla
                    playPauseBtn.querySelector('i').className = 'fa-solid fa-play'; // Ä°konu deÄŸiÅŸtir
                    document.title = originalTitle;
                    faviconPlaying.remove();
                    document.head.appendChild(faviconDefault);
                });
                // YENÄ°: Ses seviyesini ayarla ve widget'tan gelen deÄŸere gÃ¶re slider'Ä± gÃ¼ncelle
                widget.setVolume(volumeSlider.value);
                widget.getVolume((volume) => volumeSlider.value = volume);

                startTrackChangeInterval(); // DÃœZELTME: ÅžarkÄ± deÄŸiÅŸikliÄŸi kontrolÃ¼nÃ¼ yeniden baÅŸlat
            });
        }

        function updateTrackInfo() {
            widget.getCurrentSound(function(sound) {
                if (!sound) return;
                const titleSpan = titleEl.querySelector('span');
                titleSpan.innerText = sound.title;
                artistEl.innerText = sound.user.username;

                // YENÄ°: Dinamik sayfa baÅŸlÄ±ÄŸÄ± ve favicon
                if (isPlaying) {
                    document.title = `â–¶ ${sound.title} - ${sound.user.username}`;
                    faviconDefault.remove();
                    document.head.appendChild(faviconPlaying);
                }
                // DÃœZELTME: Sadece metin taÅŸÄ±yorsa kaydÄ±rma sÄ±nÄ±fÄ±nÄ± ekle.
                titleEl.classList.toggle('scrolling', titleSpan.scrollWidth > titleEl.clientWidth);
                
                const bgAfter = document.querySelector('#bg-layer::after');

                if(sound.artwork_url) {
                    const highResUrl = sound.artwork_url.replace('-large', '-t500x500');
                    // DÃœZELTME: YumuÅŸak geÃ§iÅŸ iÃ§in doÄŸrudan deÄŸiÅŸtirmek yerine ::after elementini kullan
                    bgLayer.style.setProperty('--bg-image-url', `url('${highResUrl}')`);
                    recordImg.src = highResUrl;
                } else {
                    // Resim yoksa ::after elementini gizle
                    bgLayer.style.setProperty('--bg-image-url', 'none');
                    targetPalette = [[213, 0, 249], [0, 229, 255]];
                }
            });
        }

        // --- KONTROL EVENTLERÄ° ---
        function resizeCanvas() {
            const w = vizPanel.offsetWidth;
            const h = vizPanel.offsetHeight;
            canvas.width = w; canvas.height = h;
            canvas3D.width = w; canvas3D.height = h;
            gridCanvas.width = window.innerWidth;
            gridCanvas.height = window.innerHeight;
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
            if (three.renderer) { three.renderer.setSize(w, h); three.renderer.setPixelRatio(window.devicePixelRatio); }
            if (three.camera) { three.camera.aspect = w / h; three.camera.updateProjectionMatrix(); }
        }
        window.addEventListener('resize', resizeCanvas);
        setTimeout(resizeCanvas, 100);

        artistSwitcher.onclick = function(event) {
            event.stopPropagation();

            // --- DÃœZELTME: Mevcut durumu tamamen sÄ±fÄ±rla ---
            // 1. Mevcut ÅŸarkÄ± bilgisi kontrolÃ¼nÃ¼ durdur
            if (trackChangeInterval) {
                clearInterval(trackChangeInterval);
                trackChangeInterval = null;
            }
            // 2. Widget referansÄ±nÄ± ve oynatma durumunu temizle
            widget = null;
            stopSimulationBeat();
            isPlaying = false;
            // 3. ArayÃ¼zÃ¼ sÄ±fÄ±rla
            titleEl.querySelector('span').innerText = 'Loading...';
            artistEl.innerText = '...';
            titleEl.classList.remove('scrolling'); // DÃœZELTME: KaydÄ±rma efektini sÄ±fÄ±rla
            recordImg.src = defaultImageBase64; // Kapak resmini sÄ±fÄ±rla

            iframeElement.style.opacity = '0'; // YENÄ°: YumuÅŸak geÃ§iÅŸ iÃ§in eskiyi gizle
            // --- DÃœZELTME: iframe'i tamamen yeniden oluÅŸtur ---
            currentArtistIndex = (currentArtistIndex + 1) % artists.length;
            const newArtist = artists[currentArtistIndex];
            loader.classList.remove('hidden');

            const scContent = document.querySelector('.sc-content');
            const oldIframe = document.getElementById('sc-frame');
            if (oldIframe) oldIframe.remove(); // Eski iframe'i DOM'dan kaldÄ±r

            const newIframe = document.createElement('iframe');
            newIframe.id = 'sc-frame';
            newIframe.scrolling = 'auto';
            newIframe.frameBorder = 'no';
            newIframe.allow = 'autoplay';
            const baseUrl = "https://w.soundcloud.com/player/?url=";
            const params = "&color=%237b1fa2&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=false";
            // DÃœZELTME: SanatÃ§Ä± deÄŸiÅŸtirildiÄŸinde her zaman standart liste gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ (`visual=false`) kullan.
            newIframe.src = baseUrl + newArtist.url + params;
            newIframe.onload = () => {
                initializeWidget();
                newIframe.style.opacity = '1'; // YENÄ°: YÃ¼klendiÄŸinde yavaÅŸÃ§a gÃ¶ster
            };
            scContent.prepend(newIframe); // Yeni iframe'i konteynerin baÅŸÄ±na ekle
            iframeElement = newIframe; // Global referansÄ± gÃ¼ncelle
        }

        styleSwitcher.onclick = function(event) {
            event.stopPropagation();
            // YENÄ°: GeliÅŸmiÅŸ geÃ§iÅŸ animasyonu
            const currentCanvas = visualizerStyles[currentStyleIndex].name.startsWith('3d-') ? canvas3D : canvas;
            currentCanvas.style.opacity = '0';
            currentCanvas.style.transform = 'scale(0.95) ';
            currentCanvas.style.filter = 'blur(10px)';

            setTimeout(() => {
                currentStyleIndex = (currentStyleIndex + 1) % visualizerStyles.length;
                const newStyle = visualizerStyles[currentStyleIndex];
                styleSwitcher.querySelector('i').className = newStyle.icon;
                
                const nextCanvas = newStyle.name.startsWith('3d-') ? canvas3D : canvas;
                const otherCanvas = newStyle.name.startsWith('3d-') ? canvas : canvas3D;
                
                otherCanvas.style.display = 'none';
                nextCanvas.style.display = 'block';
                nextCanvas.style.opacity = '1';
                nextCanvas.style.transform = 'scale(1)';
                nextCanvas.style.filter = 'blur(0px)';

                if (newStyle.name.startsWith('3d-')) {
                    if (!three.initialized) three.init();
                }
            }, 300);
        }

        settingsBtn.onclick = (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('visible');
        };
        document.onclick = (e) => {
            if (!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsPanel.classList.remove('visible');
            }
        };
        effectIntensitySlider.oninput = (e) => {
            settings.effectIntensity = parseFloat(e.target.value);
            saveSettings();
        };
        bgBlurSlider.oninput = (e) => {
            settings.backgroundBlur = parseFloat(e.target.value);
            if (currentMode === 'simulation') bgLayer.style.filter = `blur(${settings.backgroundBlur}px) brightness(0.6) hue-rotate(${hueShiftAngle}deg)`;
            saveSettings();
        };
        particleToggle.onchange = (e) => {
            settings.useParticles = e.target.checked;
            particleCanvas.style.opacity = settings.useParticles ? '1' : '0';
            saveSettings();
        };

        // YENÄ°: SoundCloud Sekme GeÃ§iÅŸleri
        tabProfile.onclick = () => {
            tabProfile.classList.add('active');
            tabTopSongs.classList.remove('active');
            scTopSongsFrame.style.opacity = '0';
            scTopSongsFrame.style.visibility = 'hidden';
        };
        tabTopSongs.onclick = () => {
            tabTopSongs.classList.add('active');
            tabProfile.classList.remove('active');
            scTopSongsFrame.style.opacity = '1';
            scTopSongsFrame.style.visibility = 'visible';
        };

        // YENÄ°: ÅžarkÄ± Kontrol ButonlarÄ± OlaylarÄ±
        playPauseBtn.onclick = (e) => {
            e.stopPropagation();
            if (widget) widget.toggle();
        };
        nextBtn.onclick = (e) => {
            e.stopPropagation();
            if (widget) widget.next();
        };
        prevBtn.onclick = (e) => {
            e.stopPropagation();
            if (widget) widget.prev();
        };

        // YENÄ°: Ses KontrolÃ¼ OlaylarÄ±
        volumeSlider.oninput = (e) => {
            if (widget) widget.setVolume(e.target.value);
            const newVolume = parseInt(e.target.value, 10);
            updateVolumeIcon(newVolume);
            saveVolume(newVolume); // YENÄ°: Sesi kaydet
        };
        volumeBtn.onclick = (e) => {
            e.stopPropagation();
            if (volumeSlider.value > 0) {
                volumeSlider.dataset.lastVolume = volumeSlider.value; // Son ses seviyesini kaydet
                volumeSlider.value = 0;
            } else {
                volumeSlider.value = volumeSlider.dataset.lastVolume || 80; // KaydedilmiÅŸ seviyeye veya varsayÄ±lana dÃ¶n
            }
            if (widget) widget.setVolume(volumeSlider.value);
            const newVolume = parseInt(volumeSlider.value, 10);
            updateVolumeIcon(newVolume);
            saveVolume(newVolume); // YENÄ°: Sesi kaydet
        };
        function saveVolume(volume) {
            settings.volume = volume;
            saveSettings();
        }
        function updateVolumeIcon(volume) {
            const icon = volumeBtn.querySelector('i');
            if (volume == 0) {
                icon.className = 'fa-solid fa-volume-xmark';
            } else if (volume < 50) {
                icon.className = 'fa-solid fa-volume-low';
            } else {
                icon.className = 'fa-solid fa-volume-high';
            }
        }
        // --- YENÄ°: Profesyonel EtkileÅŸimler ---
        document.addEventListener('mousemove', handleUserActivity);
        document.addEventListener('keydown', handleKeyboardShortcuts);

        
        // --- SÄ°STEM BAÅžLATMA / DURDURMA ---
        startBtn.onclick = async function() { 
            if (currentMode === 'realtime') { stopSystem(); return; }
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true, audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }, 
                    selfBrowserSurface: "include", systemAudio: "include" 
                });
                if (stream.getAudioTracks().length === 0) {
                    stream.getTracks().forEach(track => track.stop());
                    alert("HATA: 'Sesi PaylaÅŸ' kutucuÄŸunu iÅŸaretlemedin!");
                    return;
                }
                // Ä°pucu metinlerini gizle
                hintText.classList.add('hidden');
                explanationText.classList.add('hidden');
                stopSimulationBeat(); // SimÃ¼lasyonu durdur
                currentMode = 'realtime';
                startBtn.innerHTML = '<i class="fa-solid fa-stop-circle"></i> CANLIYI DURDUR';
                startBtn.style.background = "#d32f2f";
                startBtn.classList.add('pulsating-live'); // YENÄ°: NabÄ±z efektini baÅŸlat
                stream.getTracks()[0].onended = () => stopSystem();
                resizeCanvas();
                setupAudioAnalysis(stream);
            } catch (err) { if (err.name !== 'NotAllowedError') alert("Hata: " + err.message); }
        };

        function stopSystem() {
            if (trackChangeInterval) { clearInterval(trackChangeInterval); trackChangeInterval = null; }
            currentMode = 'simulation';
            startBtn.innerHTML = '<i class="fa-solid fa-broadcast-tower"></i> CANLI SENKRONÄ°ZASYONU BAÅžLAT';
            startBtn.disabled = false;
            startBtn.style.background = "linear-gradient(90deg, #7b1fa2 0%, #4a148c 100%)";
            startBtn.classList.remove('pulsating-live'); // YENÄ°: NabÄ±z efektini durdur
            
            // Ä°pucu metinlerini tekrar gÃ¶ster
            hintText.classList.remove('hidden');
            explanationText.classList.remove('hidden');

            // DÃœZELTME: YumuÅŸak geÃ§iÅŸ iÃ§in arka planÄ± sÄ±fÄ±rla
            const bgAfter = document.querySelector('#bg-layer::after');
            bgLayer.style.setProperty('--bg-image-url', 'none');

            bgLayer.style.filter = `blur(${settings.backgroundBlur}px) brightness(0.6)`;
            document.body.style.setProperty('--vignette-opacity', '0');
            titleEl.style.textShadow = ''; artistEl.style.textShadow = '';
            if(audioContext) audioContext.close();
        }

        // --- SES ANALÄ°ZÄ° VE EFEKTLER ---
        let lastBeatTime = 0, beatIntervals = [], currentBPM = 120, smoothedBPM = 120, beatIntensity = 0;
        const PALETTES = {
            ENERGETIC: [[255, 0, 80], [255, 100, 0]], // KÄ±rmÄ±zÄ±/Turuncu
            DARK: [[130, 0, 255], [20, 20, 40]], // Mor/Koyu Mavi
            CHILL: [[0, 255, 150], [0, 150, 255]], // Turkuaz/Mavi
            ATMOSPHERIC: [[220, 220, 255], [150, 180, 255]] // AÃ§Ä±k Pastel
        };

        function setupAudioAnalysis(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.8;
            const bufferLength = analyser.frequencyBinCount;
            startTrackChangeInterval();
        }

        function processAudioData(sourceData, numBars) {
            if (!sourceData) return new Uint8Array(numBars).fill(0);
            const processedData = new Uint8Array(numBars);
            const sourceLength = sourceData.length;
            const step = Math.floor(sourceLength / numBars);
            if (step < 1) return sourceData;

            for (let i = 0; i < numBars; i++) {
                const start = i * step;
                const end = start + step;
                let sum = 0;
                for (let j = start; j < end; j++) {
                    sum += sourceData[j];
                }
                processedData[i] = sum / step;
            }
            return processedData;
        }

        // --- SÄ°MÃœLASYON MODU FONKSÄ°YONLARI ---
        function startSimulationBeat() {
            if (simulationBeatInterval || currentMode !== 'simulation' || !isPlaying) return;
            const bpm = 120; // Ortalama bir BPM deÄŸeri
            const interval = 60000 / bpm; // Bu interval artÄ±k sadece ÅŸok dalgasÄ± iÃ§in kullanÄ±lacak
            simulationBeatInterval = setInterval(() => {
                if (visualizerStyles[currentStyleIndex].name === 'pulse') createShockwave(150);
            }, interval);
        }

        function stopSimulationBeat() {
            clearInterval(simulationBeatInterval);
            simulationBeatInterval = null;
        }

        // --- ANA ANÄ°MASYON DÃ–NGÃœSÃœ ---
        let lowPass = 0;
        // YENÄ°: GeliÅŸmiÅŸ simÃ¼lasyon iÃ§in durum deÄŸiÅŸkenleri
        const sim = {
            time: 0,
            bassPulse: 0,
            treblePulse: 0,
            lastBassBeat: 0,
            lastTrebleBeat: 0,
            bassInterval: 60000 / 120, 
            trebleInterval: (60000 / 120) / 2,
        };

        let patternTime = 0; // YENÄ°: Desen animasyonlarÄ± iÃ§in zamanlayÄ±cÄ±
        function mainLoop() {
            let trebleAvg = 0;
            requestAnimationFrame(mainLoop);
            
            let dataArray = null; // DÃœZELTME: Bu satÄ±rÄ±n yeri yanlÄ±ÅŸ. AÅŸaÄŸÄ±ya taÅŸÄ±ndÄ±.
            let bassAvg = 0;
            const now = Date.now();

            if (currentMode === 'realtime' && analyser) {
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                // GerÃ§ek bass ortalamasÄ±nÄ± daha doÄŸru hesapla
                let bassSum = 0, trebleSum = 0;
                const bassEnd = Math.floor(bufferLength * 0.15);
                const trebleStart = Math.floor(bufferLength * 0.4);
                const trebleEnd = Math.floor(bufferLength * 0.8);

                for (let i = 0; i < bassEnd; i++) bassSum += dataArray[i];
                for (let i = trebleStart; i < trebleEnd; i++) trebleSum += dataArray[i];

                bassAvg = (bassSum / bassEnd) * 1.2 || 0; // BasÄ± biraz daha vurgula
                trebleAvg = (trebleSum / (trebleEnd - trebleStart)) || 0;

                // GerÃ§ek zamanlÄ± BPM ve vuruÅŸ tespiti
                lowPass = lowPass * 0.9 + 0.1 * bassAvg;
                if (bassAvg > lowPass + 35 && Date.now() - lastBeatTime > 250) {
                    lastBeatTime = Date.now();
                    beatIntensity = 1;
                    if (visualizerStyles[currentStyleIndex].name === 'pulse') createShockwave(bassAvg);
                }
                // DÃœZELTME: GerÃ§ek zamanlÄ± modda 2D Ã§izim fonksiyonlarÄ±nÄ± burada Ã§aÄŸÄ±r.
                // Bu, ses verisinin gÃ¶rselleÅŸtiricilere doÄŸru ÅŸekilde aktarÄ±lmasÄ±nÄ± saÄŸlar.
                drawFrame(dataArray, isPlaying, beatIntensity * settings.effectIntensity);

            } else { // DÃœZELTME: YumuÅŸatÄ±lmÄ±ÅŸ Estetik Desen SimÃ¼lasyonu
                patternTime += 0.01;

                // DÃœZELTME: "Kalp atÄ±ÅŸÄ±" yerine yumuÅŸak "nefes alma" efekti.
                // MÃ¼zik Ã§alÄ±yorsa, beatIntensity sinÃ¼s dalgasÄ±yla 0 ve 1 arasÄ±nda yumuÅŸakÃ§a salÄ±nÄ±r.
                const targetIntensity = isPlaying ? (Math.sin(patternTime * 2) * 0.5 + 0.5) : 0;
                beatIntensity += (targetIntensity - beatIntensity) * 0.1; // Daha hÄ±zlÄ± tepki iÃ§in 0.02'den 0.1'e yÃ¼kseltildi.

                // DÃœZELTME: dataArray'i burada, koÅŸullu bloklardan Ã¶nce sÄ±fÄ±rla.
                dataArray = null;

                const currentStyleName = visualizerStyles[currentStyleIndex].name;

                if (currentStyleName.startsWith('3d-')) {
                    // DÃœZELTME: 3D modundayken, 2D canvas'Ä± temizleme ve dataArray'i null yapma.
                    // Her zaman sahte veri oluÅŸturarak 3D motorunun Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸla.
                    const bufferLength = 128;
                    dataArray = new Uint8Array(bufferLength);
                    for (let i = 0; i < bufferLength; i++) {
                        const a = Math.sin(patternTime * 2 + i * 0.2) * 0.5 + 0.5;
                        dataArray[i] = a * 100 + beatIntensity * 150;
                    }
                    bassAvg = (Math.sin(patternTime * 2) * 0.5 + 0.5) * 150;
                } else {
                    // DÃœZELTME: 2D modundayken dataArray'i null yap ve 2D Ã§izimlerini gerÃ§ekleÅŸtir.
                    dataArray = null; 
                    bassAvg = (Math.sin(patternTime * 2) * 0.5 + 0.5) * 150;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    titleEl.style.opacity = artistEl.style.opacity = (currentStyleName === 'circle' || currentStyleName === 'pulse') ? '1' : '0';
                    switch (currentStyleName) {
                        case 'circle':
                            drawSimCirclePattern(patternTime, beatIntensity);
                            drawRecordPlayer(isPlaying);
                            break;
                        case 'line':
                            drawSimLinePattern(patternTime, beatIntensity);
                            break;
                        case 'mirror':
                            drawSimMirrorPattern(patternTime, beatIntensity);
                            break;
                        case 'pulse':
                            drawSimPulsePattern(patternTime, beatIntensity);
                            break;
                    }
                }
            }

            // Renkleri yumuÅŸakÃ§a hedefe doÄŸru ilerlet
            for(let i=0; i<2; i++) for(let j=0; j<3; j++) currentPalette[i][j] += (targetPalette[i][j] - currentPalette[i][j]) * 0.02;

            // DÃœZELTME: VuruÅŸ enerjisini her zaman azalt. Bu, efektlerin takÄ±lÄ± kalmasÄ±nÄ± Ã¶nler. (KoÅŸul dÄ±ÅŸÄ±na taÅŸÄ±ndÄ±)
            beatIntensity *= 0.92;

            // --- VURUÅž ENERJÄ°SÄ°NE DAYALI EFEKTLER (AYARLANABÄ°LÄ°R) ---
            const intensity = settings.effectIntensity;
            const panelScale = 1 + (beatIntensity * 0.015 * intensity);
            vizPanel.style.transform = `scale(${panelScale})`; 
            // DÃœZELTME: ParlaklÄ±k ve renk deÄŸiÅŸimini daha yumuÅŸak ve profesyonel hale getir.
            let brightness = 0.3 + (bassAvg / 255) * 0.3 + (beatIntensity * 0.1 * intensity); // Gece modu iÃ§in parlaklÄ±k tepkisini azalt.
            document.body.style.setProperty('--vignette-opacity', String(beatIntensity * 0.3 * intensity)); // DÃœZELTME: KÃ¶ÅŸe karartma efektini azalt
            let hueRotate = (bassAvg / 4); // Renk deÄŸiÅŸim hÄ±zÄ±nÄ± yavaÅŸlat.
            bgLayer.style.filter = `blur(${settings.backgroundBlur}px) brightness(${brightness}) hue-rotate(${hueRotate}deg)`;
            const textGlow = (bassAvg / 255) * 25;
            titleEl.style.textShadow = `0 0 ${10 + textGlow}px rgba(255, 255, 255, 0.7), 0 0 ${20 + textGlow * 1.5}px rgba(213, 0, 249, 0.5)`;
            artistEl.style.textShadow = `0 0 ${2 + textGlow * 0.2}px rgba(255, 255, 255, 0.5)`;

            // Ã‡izim fonksiyonlarÄ±nÄ± Ã§aÄŸÄ±r
            drawGrid(beatIntensity * intensity);
            animateParticles(); // ParÃ§acÄ±k animasyonunu ana dÃ¶ngÃ¼den Ã§aÄŸÄ±r
            if (three.initialized) three.update(dataArray, beatIntensity * intensity, bassAvg, trebleAvg);
        }

        function startTrackChangeInterval() {
            if (trackChangeInterval) clearInterval(trackChangeInterval);
            let lastPlayedSoundId = null;
            trackChangeInterval = setInterval(() => {
                if (!widget) return;
                widget.getCurrentSound((currentSound) => {
                    if (currentSound && currentSound.id !== lastPlayedSoundId) {
                        lastPlayedSoundId = currentSound.id;
                        updateTrackInfo();
                    }
                });
            }, 1000);
        }

        // --- 2D Ã‡Ä°ZÄ°M FONKSÄ°YONLARI ---
        function drawFrame(dataArray, isAnimating, beatIntensity = 0) {
            if (!dataArray) return; // EÄŸer data yoksa Ã§izim yapma (simÃ¼lasyon modu iÃ§in)
            const processedData = processAudioData(dataArray, 64); // Veriyi 64 Ã§ubuÄŸa indirge
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const style = visualizerStyles[currentStyleIndex].name;
            const is3D = style.startsWith('3d-');
            titleEl.style.opacity = artistEl.style.opacity = (is3D || style === 'line' || style === 'mirror') ? '0' : '1';
            if (style === 'circle') drawCircleVisualizer(processedData, beatIntensity);
            else if (style === 'line') drawLineVisualizer(processedData, beatIntensity);
            else if (style === 'mirror') drawMirrorVisualizer(processedData, beatIntensity);
            else if (style === 'pulse') drawPulseVisualizer(processedData, beatIntensity);
            if (style === 'circle') drawRecordPlayer(isAnimating);
        }
        function drawCircleVisualizer(dataArray, beatIntensity) {
            const centerX = canvas.width / 2, centerY = canvas.height / 2, radius = 160;
            if (!dataArray) return;

            // OPTÄ°MÄ°ZASYON: Her Ã§izgi iÃ§in gÃ¶lge Ã§izmek yerine, tÃ¼m Ã§izgileri tek seferde Ã§iz.
            // VE: TÃ¼m Ã§izgileri tek bir path'de birleÅŸtirerek Ã§izim Ã§aÄŸrÄ±larÄ±nÄ± azalt.
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.shadowColor = getRainbowColor(patternTime + 0.5);
            ctx.shadowBlur = 15;
            
            ctx.beginPath(); // TÃ¼m Ã§izgiler iÃ§in tek bir path baÅŸlat
            for (let i = 0; i < dataArray.length; i++) {
                // YENÄ°: GeliÅŸmiÅŸ Kanal Dengeleme (Bas Enerjisi AktarÄ±mÄ±)
                const rawValue = dataArray[i];
                const progress = i / dataArray.length;
                const bassEnergy = (dataArray[0] + dataArray[1]) / 2;
                const bassContribution = bassEnergy * progress * 0.5; // Sona doÄŸru bas etkisini artÄ±r
                const dynamicValue = Math.pow(rawValue, 0.9) + bassContribution;
                const value = Math.min(255, dynamicValue);
                const beatMultiplier = 1 + (beatIntensity * 0.25);
                const barHeight = (value * 0.9 * beatMultiplier) + 5 ;
                const angle = (i * 2 * Math.PI) / dataArray.length;
                const cos = Math.cos(angle);
                const sin = Math.sin(angle);
                const xStart = centerX + cos * radius, yStart = centerY + sin * radius;
                const xEnd = centerX + cos * (radius + barHeight), yEnd = centerY + sin * (radius + barHeight);
                ctx.moveTo(xStart, yStart);
                ctx.lineTo(xEnd, yEnd);
            }
            ctx.strokeStyle = getRainbowColor(patternTime);
            ctx.stroke(); // TÃ¼m Ã§izgileri tek seferde Ã§iz
        }
        function drawFadedArtwork() {
            if (recordImg.complete && recordImg.naturalWidth > 0) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const h = canvas.height;
                const w = (h / recordImg.height) * recordImg.width;
                ctx.save();
                ctx.globalAlpha = 0.1; // Soluk bir gÃ¶rÃ¼nÃ¼m iÃ§in
                ctx.drawImage(recordImg, centerX - w / 2, centerY - h / 2, w, h);
                ctx.restore();
            }
        }
        function drawLineVisualizer(dataArray, beatIntensity) {
            if (!dataArray) return;
            const numBars = dataArray.length;
            const barWidth = canvas.width / numBars;
            let x = 0;
            for (let i = 0; i < numBars; i++) {
                // DÃœZELTME: Logaritmik gÃ¼Ã§lendirmeyi tÃ¼m efektlere uygula
                 const rawValue = dataArray[i];
                const progress = i / numBars;
                const bassEnergy = (dataArray[0] + dataArray[1]) / 2;
                const bassContribution = bassEnergy * progress * 0.4;
                const dynamicValue = Math.pow(rawValue, 0.9) + bassContribution;
                const value = Math.min(255, dynamicValue);
                const beatMultiplier = 1 + (beatIntensity * 0.3); 
                const barHeight = (value / 255) * (canvas.height * 0.7) * beatMultiplier;
                const color = getColorFromPalette(value);
                ctx.fillStyle = color; 
                ctx.shadowColor = color; 
                ctx.shadowBlur = 10;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
            drawFadedArtwork();
        }
        function drawMirrorVisualizer(dataArray, beatIntensity) {
            if (!dataArray) return;
            const numBars = dataArray.length;
            const barWidth = canvas.width / numBars;
            const centerY = canvas.height / 2;
            let x = 0;
            for (let i = 0; i < numBars; i++) {
                // DÃœZELTME: Logaritmik gÃ¼Ã§lendirmeyi tÃ¼m efektlere uygula
                 const rawValue = dataArray[i];
                const progress = i / numBars;
                const bassEnergy = (dataArray[0] + dataArray[1]) / 2;
                const bassContribution = bassEnergy * progress * 0.4;
                const dynamicValue = Math.pow(rawValue, 0.9) + bassContribution;
                const value = Math.min(255, dynamicValue);
                const beatMultiplier = 1 + (beatIntensity * 0.3); 
                const barHeight = (value / 255) * (canvas.height * 0.4) * beatMultiplier;
                const color = getColorFromPalette(value);
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                ctx.fillRect(x, centerY - barHeight, barWidth, barHeight);
                ctx.fillRect(x, centerY, barWidth, barHeight);
                x += barWidth + 1; // Ã‡ubuklar arasÄ± boÅŸluk
            }
            drawFadedArtwork();
        }
        function drawPulseVisualizer(dataArray, beatIntensity) {
            const centerX = canvas.width / 2, centerY = canvas.height / 2;
            let bassAvg = 0;
            if (dataArray) {
                let bassSum = 0;
                for (let i = 0; i < dataArray.length * 0.3; i++) { bassSum += dataArray[i]; }
                bassAvg = bassSum / (dataArray.length * 0.3);
                const beatMultiplier = 1 + (beatIntensity * 0.25);
                pulseRadius = 50 + (bassAvg / 255) * 100 * beatMultiplier;
            }
            ctx.save();
            ctx.beginPath(); 
            ctx.arc(centerX, centerY, pulseRadius, 0, Math.PI * 2); 
            ctx.clip();
            ctx.shadowColor = getColorFromPalette(bassAvg);
            ctx.shadowBlur = 25;
            ctx.fillStyle = getColorFromPalette(bassAvg);
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (recordImg.complete && recordImg.naturalWidth > 0) {
                ctx.drawImage(recordImg, centerX - pulseRadius, centerY - pulseRadius, pulseRadius * 2, pulseRadius * 2);
            }
            ctx.restore();
            updateAndDrawShockwaves();
        } 

        // --- YENÄ°: SÄ°MÃœLASYON DESEN FONKSÄ°YONLARI ---
        function drawSimCirclePattern(t, beat) {
            const centerX = canvas.width / 2, centerY = canvas.height / 2;
            const beatScale = 1 + beat * 0.2;
            ctx.lineWidth = 4;
            ctx.shadowBlur = 20;

            // Uzun, evrilen bir desen: Nefes alan halkalar, dÃ¶nen parÃ§alara dÃ¶nÃ¼ÅŸÃ¼r.
            const slowTime = t * 0.2; // Genel evrim hÄ±zÄ±
            const transition = Math.sin(slowTime) * 0.5 + 0.5; // 0 ile 1 arasÄ±nda yavaÅŸÃ§a salÄ±nÄ±r

            for (let i = 1; i < 6; i++) {
                const radius = (80 + i * 35) * beatScale;
                const color = getRainbowColor(t + i * 0.15);
                ctx.strokeStyle = color;
                ctx.shadowColor = color;

                // GeÃ§iÅŸe gÃ¶re baÅŸlangÄ±Ã§ ve bitiÅŸ aÃ§Ä±larÄ±nÄ± deÄŸiÅŸtir
                const startAngle = t * (i % 2 === 0 ? -1 : 1) * 0.5;
                const arcLength = Math.PI * 1.5 + (Math.PI * 0.5 * transition); // Halka uzunluÄŸu deÄŸiÅŸir
                const endAngle = startAngle + arcLength;

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.stroke();
            }
        }
        function drawSimLinePattern(t, beat) {
            const numBars = 40;
            const barWidth = canvas.width / numBars;
            const beatHeight = beat * (canvas.height * 0.3);
            ctx.shadowBlur = 20;

            // Uzun, evrilen bir desen: Ä°ki farklÄ± hÄ±zdaki dalganÄ±n giriÅŸimi.
            for (let i = 0; i < numBars; i++) {
                const ratio = i / numBars;
                // YavaÅŸ ana dalga
                const phase1 = t * 2 + ratio * Math.PI * 3;
                // HÄ±zlÄ± detay dalgasÄ±
                const phase2 = t * 5 + ratio * Math.PI * 8;
                // Merkezden uzaklÄ±ÄŸa gÃ¶re modÃ¼lasyon
                const distFromCenter = Math.abs(ratio - 0.5);
                const centerPulse = Math.cos(t - distFromCenter * 2) * 0.5 + 0.5;

                const height = ((Math.sin(phase1) * 0.6 + Math.sin(phase2) * 0.4) * 0.5 + 0.5) * (canvas.height * 0.4) * centerPulse + beatHeight;
                const color = getRainbowColor(t + ratio * 0.2);
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 2, height);
            }
            drawFadedArtwork();
        }
        function drawSimMirrorPattern(t, beat) {
            const numBars = 50;
            const barWidth = canvas.width / numBars;
            const centerY = canvas.height / 2;
            const beatHeight = beat * (canvas.height * 0.2);
            ctx.shadowBlur = 20;

            // Uzun, evrilen bir desen: DNA sarmalÄ± ve "V" ÅŸekli arasÄ±nda yumuÅŸak geÃ§iÅŸ.
            const slowTime = t * 0.3;
            const transition = Math.cos(slowTime) * 0.5 + 0.5; // 0-1 arasÄ± salÄ±nÄ±m

            for (let i = 0; i < numBars; i++) {
                const ratio = i / numBars;
                const distFromCenter = Math.abs(ratio - 0.5) * 2;

                // DNA sarmalÄ± iÃ§in Y ofseti
                const yOffset = Math.cos(ratio * Math.PI * 2 + t * 2) * (canvas.height * 0.15) * (1 - transition);
                // V ÅŸekli iÃ§in yÃ¼kseklik modÃ¼lasyonu
                const vShape = Math.pow(1 - distFromCenter, 2) * transition;

                const phase = t * 3 + ratio * Math.PI * 5;
                const height = (Math.sin(phase) * 0.5 + 0.5) * (canvas.height * 0.2 + canvas.height * 0.15 * vShape) + beatHeight;
                const color = getRainbowColor(t + ratio * 0.1);
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.fillRect(i * barWidth, centerY - height + yOffset, barWidth - 2, height);
                ctx.fillRect(i * barWidth, centerY - yOffset, barWidth - 2, height);
            }
            drawFadedArtwork();
        }
        function drawSimPulsePattern(t, beat) {
            const centerX = canvas.width / 2, centerY = canvas.height / 2;
            ctx.lineWidth = 5;
            ctx.shadowBlur = 25;

            // Ana "pulse" efekti
            const baseRadius = 120 + Math.sin(t * 2) * 15;
            const radius = baseRadius + beat * 60;
            const mainColor = getRainbowColor(t * 0.5);
            ctx.save();
            ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, Math.PI * 2); ctx.clip();
            ctx.fillStyle = mainColor; ctx.shadowColor = mainColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (recordImg.complete && recordImg.naturalWidth > 0) {
                ctx.globalAlpha = 0.7;
                ctx.drawImage(recordImg, centerX - radius, centerY - radius, radius * 2, radius * 2);
            }
            ctx.restore();

            // Arka planda yavaÅŸÃ§a geniÅŸleyen halkalar
            const numRings = 4;
            for (let i = 0; i < numRings; i++) {
                const ringRadius = ((t * 20 + i * 100) % 400);
                const opacity = Math.pow(1 - (ringRadius / 400), 2);
                if (opacity <= 0) continue;
                const color = getRainbowColor(t * 0.5 + i * 0.25, opacity);
                ctx.strokeStyle = color; ctx.shadowColor = color;
                ctx.beginPath(); ctx.arc(centerX, centerY, ringRadius, 0, Math.PI * 2); ctx.stroke();
            }

            // DEÄžÄ°ÅžÄ°KLÄ°K: Sakin modda ÅŸok dalgasÄ± istenmiyor.
            updateAndDrawShockwaves();
        }

        // --- YENÄ°: PROFESYONEL ETKÄ°LEÅžÄ°M FONKSÄ°YONLARI ---
        function handleUserActivity(e) {
            // YENÄ°: Dokunmatik cihazlarda sinema modunu tamamen devre dÄ±ÅŸÄ± bÄ±rak.
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isTouchDevice) {
                document.body.classList.remove('cinema-mode'); // EÄŸer aÃ§Ä±ksa kapat
                clearTimeout(cinemaModeTimeout); // ZamanlayÄ±cÄ±yÄ± temizle
                return; // Fonksiyonun geri kalanÄ±nÄ± Ã§alÄ±ÅŸtÄ±rma
            }

            // 1. Sinema modunu sÄ±fÄ±rla
            document.body.classList.remove('cinema-mode');
            clearTimeout(cinemaModeTimeout);
            cinemaModeTimeout = setTimeout(() => document.body.classList.add('cinema-mode'), cinemaModeDelay);
            
            // 2. Fareyi takip eden Ä±ÅŸÄ±ÄŸÄ± gÃ¼ncelle
            document.body.style.setProperty('--mouse-x', `${(e.clientX / window.innerWidth) * 100}%`);
            document.body.style.setProperty('--mouse-y', `${(e.clientY / window.innerHeight) * 100}%`);
        }

        function handleKeyboardShortcuts(e) {
            // YazÄ± yazÄ±lan bir alanda deÄŸilsek kÄ±sayollarÄ± Ã§alÄ±ÅŸtÄ±r
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.code) {
                case 'Space':
                    e.preventDefault(); // SayfanÄ±n kaymasÄ±nÄ± engelle
                    if (widget) widget.toggle();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (widget) widget.next(); // DÃœZELTME: Sonraki ÅŸarkÄ±ya geÃ§
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (widget) widget.prev(); // DÃœZELTME: Ã–nceki ÅŸarkÄ±ya geÃ§
                    break;
                case 'KeyS':
                    settingsBtn.click();
                    break;
            }
        }

        // --- RENK YÃ–NETÄ°MÄ° ---
        function getColorFromPalette(value) {
            const ratio = value / 255;
            const r = Math.round(currentPalette[0][0] * (1 - ratio) + currentPalette[1][0] * ratio);
            const g = Math.round(currentPalette[0][1] * (1 - ratio) + currentPalette[1][1] * ratio);
            const b = Math.round(currentPalette[0][2] * (1 - ratio) + currentPalette[1][2] * ratio);
            return `rgb(${r}, ${g}, ${b})`;
        }
        function getRainbowColor(t, opacity = 1) {
            const time = (t % 1); // 0-1 arasÄ±nda dÃ¶ngÃ¼
            const ratio = time < 0.5 ? time * 2 : (1 - time) * 2; // ÃœÃ§gen dalga (0 -> 1 -> 0)
            const r = Math.round(currentPalette[0][0] * (1 - ratio) + currentPalette[1][0] * ratio);
            const g = Math.round(currentPalette[0][1] * (1 - ratio) + currentPalette[1][1] * ratio);
            const b = Math.round(currentPalette[0][2] * (1 - ratio) + currentPalette[1][2] * ratio);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        let shockwaves = [];
        function createShockwave(value) {
            if (shockwaves.length > 5) return;
            shockwaves.push({ x: canvas.width / 2, y: canvas.height / 2, radius: 30, opacity: 1, color: getColorFromPalette(value) });
        }
        function updateAndDrawShockwaves() {
            for (let i = shockwaves.length - 1; i >= 0; i--) {
                const wave = shockwaves[i];
                wave.radius += 3;
                wave.opacity -= 0.01;
                if (wave.opacity <= 0) {
                    shockwaves.splice(i, 1);
                } else {
                    ctx.strokeStyle = wave.color.replace('rgb', 'rgba').replace(')', `, ${wave.opacity})`);
                    ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2); ctx.stroke();
                }
            }
        }
        function drawRecordPlayer(isAnimating) {
            const centerX = canvas.width / 2, centerY = canvas.height / 2;
            ctx.save(); ctx.translate(centerX, centerY);
            // DÃœZELTME: TakÄ±lma efektini Ã¶nlemek iÃ§in BPM'e baÄŸlÄ± dÃ¶nÃ¼ÅŸ yerine sabit hÄ±z kullan.
            // Bu, mÃ¼ziÄŸin ritmi ne olursa olsun akÄ±cÄ± bir dÃ¶nÃ¼ÅŸ saÄŸlar.
            if (isAnimating) rotationAngle += 0.01;

            ctx.rotate(rotationAngle);
            ctx.beginPath(); ctx.arc(0, 0, 150, 0, Math.PI * 2); ctx.closePath(); ctx.clip();
            if (recordImg.complete && recordImg.naturalWidth > 0) ctx.drawImage(recordImg, -150, -150, 300, 300);
            else { ctx.fillStyle = "#000"; ctx.fill(); }
            ctx.beginPath(); ctx.arc(0, 0, 150, 0, Math.PI * 2); ctx.lineWidth = 15; ctx.strokeStyle = "#111"; ctx.stroke();
            ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI * 2); ctx.fillStyle = "#000"; ctx.fill();
            ctx.restore();
        }

        // --- 3D YÃ–NETÄ°MÄ° (THREE.JS) ---
        const three = {
            initialized: false, scene: null, camera: null, renderer: null, 
            sphereGroup: null, orbGroup: null,
            init: function() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, canvas3D.width / canvas3D.height, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ canvas: canvas3D, alpha: true });
                this.renderer.setSize(canvas3D.width, canvas3D.height);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Performans iÃ§in sÄ±nrla

                // --- 3D KÃœRE ---
                const geometry = new THREE.IcosahedronGeometry(2, 64);
                geometry.setAttribute('basePosition', new THREE.BufferAttribute(geometry.attributes.position.array.slice(), 3));
                const material = new THREE.MeshStandardMaterial({ color: 0xffffff, wireframe: true });
                const sphere = new THREE.Mesh(geometry, material);
                this.sphereGroup = new THREE.Group();
                this.sphereGroup.add(sphere);
                this.scene.add(this.sphereGroup);

                // --- YENÄ°: Enerji KÃ¼resi ---
                this.orbGroup = new THREE.Group();
                const orbGeometry = new THREE.IcosahedronGeometry(1.8, 64);
                orbGeometry.setAttribute('basePosition', new THREE.BufferAttribute(orbGeometry.attributes.position.array.slice(), 3));
                
                // DÃœZELTME: "Full beyaz" sorununu Ã§Ã¶zmek iÃ§in ShaderMaterial yerine MeshStandardMaterial kullan.
                // Shader'lar daha karmaÅŸÄ±ktÄ±r ve Ä±ÅŸÄ±klandÄ±rma bilgisi gerektirir. Standart materyal daha gÃ¼venilirdir.
                const orbMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffffff, 
                    emissive: 0x000000, 
                    metalness: 0.4, 
                    roughness: 0.5 
                });

                const orb = new THREE.Mesh(orbGeometry, orbMaterial);
                this.orbGroup.add(orb);

                // YENÄ°: Ä°Ã§ Ã‡ekirdek
                const innerCoreGeom = new THREE.IcosahedronGeometry(0.5, 5);
                const innerCoreMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x333333 });
                const innerCore = new THREE.Mesh(innerCoreGeom, innerCoreMat);
                this.orbGroup.add(innerCore);

                this.scene.add(this.orbGroup);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                this.scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 0.8);
                pointLight.position.set(5, 5, 5);
                this.scene.add(pointLight);

                this.camera.position.z = 5;
                this.initialized = true;
            },
            update: function(dataArray, beatIntensity, bassAvg = 0, trebleAvg = 0) { // DÃœZELTME: dataArray null olabilir
                if (!this.initialized) return; 
                const style = visualizerStyles[currentStyleIndex].name;
                const color = new THREE.Color(getRainbowColor(patternTime));
                const isAnimating = isPlaying || currentMode === 'realtime';

                this.sphereGroup.visible = style === '3d-sphere';
                this.orbGroup.visible = style === '3d-orb';

                if (style === '3d-sphere') {
                    const sphere = this.sphereGroup.children[0];
                    sphere.rotation.x += 0.001; sphere.rotation.y += 0.002;
                    const positions = sphere.geometry.attributes.position;
                    const basePositions = sphere.geometry.attributes.basePosition;
                    
                    if (isAnimating && dataArray) {
                        const processedData = processAudioData(dataArray, 64);
                        for (let i = 0; i < positions.count; i++) {
                            const base_x = basePositions.getX(i);
                            const base_y = basePositions.getY(i); 
                            const base_z = basePositions.getZ(i);
                            const rawValue = processedData[i % processedData.length];
                            const dynamicValue = Math.pow(rawValue, 0.9);
                            const offset = (dynamicValue / 255) * 0.25 * (1 + beatIntensity);
                            positions.setXYZ(i, base_x * (1 + offset), base_y * (1 + offset), base_z * (1 + offset));
                        }
                    } else {
                        positions.copy(basePositions); // DÃœZELTME: MÃ¼zik yoksa orijinal pÃ¼rÃ¼zsÃ¼z haline dÃ¶ndÃ¼r
                    }
                    positions.needsUpdate = true;
                    sphere.geometry.computeVertexNormals();
                    sphere.material.color.lerp(color, 0.1);
                }

                if (style === '3d-orb') {
                    const orb = this.orbGroup.children[0];
                    orb.rotation.x += 0.001; orb.rotation.y += 0.002;
                    const positions = orb.geometry.attributes.position;
                    const basePositions = orb.geometry.attributes.basePosition.array;
                    const newPositions = new Float32Array(basePositions); // Her karede yeni bir dizi oluÅŸtur
                    
                    if (isAnimating) {
                        // Deprem DalgalanmasÄ± Efekti
                        for (let i = 0; i < positions.count; i++) {
                            const base_x = basePositions[i * 3];
                            const base_y = basePositions[i * 3 + 1];
                            const base_z = basePositions[i * 3 + 2];

                            // Ana "deprem" dalgasÄ± (Bastan etkilenir)
                            const bassWave = Math.sin(base_x * 5 + patternTime * 4) * Math.cos(base_y * 5 + patternTime * 2);
                            
                            // YÃ¼zeydeki hÄ±zlÄ± "titreÅŸimler" (Tizden etkilenir)
                            const trebleWave = Math.sin(base_y * 25 + patternTime * 20) * Math.cos(base_z * 25 + patternTime * 15);
                            const waveFactor = bassWave + (trebleWave * (trebleAvg / 255) * 0.5);
                            const amplitude = (bassAvg / 255) * 0.08 + beatIntensity * 0.15;
                            const waveOffset = 1.0 + waveFactor * amplitude;

                            newPositions[i * 3] = base_x * waveOffset;
                            newPositions[i * 3 + 1] = base_y * waveOffset;
                            newPositions[i * 3 + 2] = base_z * waveOffset;
                        }
                    }
                    
                    // DÃœZELTME: MÃ¼zik varsa hesaplanmÄ±ÅŸ, yoksa orijinal pozisyonlarÄ± ata.
                    positions.set(isAnimating ? newPositions : basePositions);
                    positions.needsUpdate = true;
                    orb.geometry.computeVertexNormals();

                    // Shader materyalini ve iÃ§ Ã§ekirdeÄŸi gÃ¼ncelle
                    orb.material.color.lerp(color, 0.1); 
                    orb.material.emissive.set(color).multiplyScalar(beatIntensity * 0.5); 

                    const innerCore = this.orbGroup.children[1];
                    innerCore.scale.setScalar(1 + beatIntensity * 0.5);
                    innerCore.material.color.set(getRainbowColor(patternTime + 0.2)); 
                    innerCore.material.emissive.set(getRainbowColor(patternTime + 0.2)).multiplyScalar(0.5);
                }

                this.renderer.render(this.scene, this.camera);
            }
        };

        // Vignette opaklÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in CSS deÄŸiÅŸkeni kullanalÄ±m
        document.body.style.setProperty('--vignette-opacity', '0');


        // --- YENÄ°: ARKA PLAN GRID Ã‡Ä°ZÄ°MÄ° ---
        function drawGrid(beatIntensity) {
            gCtx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
            const step = 50;
            const centerX = gridCanvas.width / 2;
            const horizonY = gridCanvas.height * 0.4;
            const beatGlow = 0; // DÃœZELTME: Grid parlamasÄ±nÄ± tamamen kaldÄ±r.

            // Grid rengini ana paletten al
            const gridColor = `rgb(${currentPalette[0][0]}, ${currentPalette[0][1]}, ${currentPalette[0][2]})`;

            gCtx.strokeStyle = `rgba(${currentPalette[0].join(',')}, 0.2)`;
            gCtx.shadowColor = `rgba(0,0,0,0)`; // DÃœZELTME: Parlama rengini gÃ¶rÃ¼nmez yap.
            gCtx.shadowBlur = beatGlow;

            // Yatay Ã§izgiler
            for (let i = 0; i < 20; i++) {
                const y = horizonY + i * i;
                if (y > gridCanvas.height) break;
                gCtx.beginPath();
                gCtx.moveTo(0, y);
                gCtx.lineTo(gridCanvas.width, y);
                gCtx.stroke();
            }

            // Dikey (perspektif) Ã§izgiler
            for (let i = -20; i <= 20; i++) {
                if (i === 0) continue;
                const x = centerX + i * step;
                gCtx.beginPath();
                gCtx.moveTo(centerX, horizonY);
                gCtx.lineTo(x, gridCanvas.height);
                gCtx.stroke();
            }
            gCtx.shadowBlur = 0; // Sonraki Ã§izimleri etkilememesi iÃ§in sÄ±fÄ±rla
        }


        // --- ARKA PLAN PARÃ‡ACIK ANÄ°MASYONU ---
        let particlesArray, shootingStars = [], hueShiftAngle = 0;
        class Particle {
            constructor() {
                this.x = Math.random() * particleCanvas.width;
                this.y = Math.random() * particleCanvas.height;
                this.size = Math.random() * 1.5 + 1;
                this.speedX = (Math.random() * 0.4) - 0.2;
                this.speedY = (Math.random() * 0.4) - 0.2;
            }
            update() {
                if (this.x > particleCanvas.width || this.x < 0) { this.speedX = -this.speedX; }
                if (this.y > particleCanvas.height || this.y < 0) { this.speedY = -this.speedY; }
                const speedMultiplier = (currentMode === 'realtime' && smoothedBPM > 0) ? (smoothedBPM / 120) : 1;
                this.x += this.speedX * speedMultiplier;
                this.y += this.speedY * speedMultiplier;
            }
            draw() {
                pCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                pCtx.beginPath();
                pCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                pCtx.fill();
            }
        }
        // YENÄ°: YÄ±ldÄ±z KaymasÄ± Efekti
        class ShootingStar {
            constructor() {
                this.reset();
                this.y = Math.random() * particleCanvas.height;
            }
            reset() {
                this.x = Math.random() > 0.5 ? -50 : particleCanvas.width + 50;
                this.y = Math.random() * particleCanvas.height * 0.6; // EkranÄ±n Ã¼st %60'Ä±nda baÅŸlasÄ±n
                this.len = Math.random() * 80 + 10;
                this.speed = Math.random() * 5 + 4;
                this.angle = Math.random() * 0.4 - 0.2;
                if (this.x > particleCanvas.width) this.speed = -this.speed;
            }
            draw() {
                const grad = pCtx.createLinearGradient(this.x, this.y, this.x + this.len * Math.cos(this.angle), this.y + this.len * Math.sin(this.angle));
                grad.addColorStop(0, getRainbowColor(patternTime + this.x / particleCanvas.width, 0.6)); // DÃœZELTME: YÄ±ldÄ±z renginin opaklÄ±ÄŸÄ±nÄ± azalt
                grad.addColorStop(1, "transparent");
                pCtx.strokeStyle = grad; pCtx.lineWidth = 2; pCtx.beginPath(); pCtx.moveTo(this.x, this.y); pCtx.lineTo(this.x + this.len * Math.cos(this.angle), this.y + this.len * Math.sin(this.angle)); pCtx.stroke();
            }
        }
        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (particleCanvas.height * particleCanvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                particlesArray.push(new Particle());
            }
        }
        function connectParticles() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x))
                               + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                    if (distance < (particleCanvas.width/7) * (particleCanvas.height/7)) {
                        opacityValue = 1 - (distance/20000);
                        // DÃœZELTME: MÃ¼zik Ã§almadÄ±ÄŸÄ±nda da hafifÃ§e gÃ¶rÃ¼nÃ¼r olmasÄ±nÄ± saÄŸla, Ã§alarken belirginleÅŸsin.
                        pCtx.strokeStyle = `rgba(213, 0, 249, ${opacityValue * (0.02 + beatIntensity * 0.08)})`;
                        pCtx.lineWidth = 1;
                        pCtx.beginPath();
                        pCtx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        pCtx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        pCtx.stroke();
                    }
                }
            }
        }
        function animateParticles() {
            pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            
            // YÄ±ldÄ±zlarÄ± Ã§iz ve gÃ¼ncelle
            if (shootingStars.length > 0) {
                shootingStars.forEach(star => {
                    star.x += star.speed;
                    star.draw();
                    if (star.x < -100 || star.x > particleCanvas.width + 100) star.reset();
                });
            }

            // ParÃ§acÄ±klarÄ± Ã§iz ve gÃ¼ncelle
            if (settings.useParticles && particlesArray) {
                for (let i = 0; i < particlesArray.length; i++) particlesArray[i].update();
                for (let i = 0; i < particlesArray.length; i++) particlesArray[i].draw();
                connectParticles();
            }
            if (currentMode === 'simulation' && !isPlaying) {
                hueShiftAngle = (hueShiftAngle + 0.05) % 360;
                bgLayer.style.filter = `blur(${settings.backgroundBlur}px) brightness(0.6) hue-rotate(${hueShiftAngle}deg)`;
            }
            // requestAnimationFrame(animateParticles); // Ana dÃ¶ngÃ¼ye taÅŸÄ±ndÄ±
        }
        
        // --- BAÅžLANGIÃ‡ ---
        mainLoop(); // ANA ANÄ°MASYON DÃ–NGÃœSÃœNÃœ HEMEN BAÅžLAT
        loadSettings(); // YENÄ°: KaydedilmiÅŸ ayarlarÄ± yÃ¼kle

        // YENÄ°: Dokunmatik cihazlarda canlÄ± senkronizasyon butonunu gizle.
        // Bu Ã¶zellik mobil cihazlarda desteklenmediÄŸi iÃ§in butonu kaldÄ±rÄ±yoruz.
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (isTouchDevice) {
            document.querySelector('.controls-wrapper').style.display = 'none';
        }

        iframeElement = document.getElementById('sc-frame'); // Ä°lk iframe referansÄ±nÄ± al
        iframeElement.onload = initializeWidget; // Ä°lk yÃ¼kleme iÃ§in onload olayÄ±nÄ± ata
        initializeWidget();

        // GiriÅŸ animasyonunun akÄ±cÄ± olmasÄ± iÃ§in parÃ§acÄ±k motorunu hafif bir gecikmeyle baÅŸlat.
        // Bu, tarayÄ±cÄ±nÄ±n ilk animasyona odaklanmasÄ±nÄ± saÄŸlar ve "kasÄ±lma" hissini ortadan kaldÄ±rÄ±r.
        setTimeout(() => {
            initParticles();
            // YENÄ°: 3 adet kayan yÄ±ldÄ±z oluÅŸtur
            for(let i=0; i<3; i++) {
                setTimeout(() => shootingStars.push(new ShootingStar()), i * 1500); // FarklÄ± zamanlarda baÅŸlasÄ±nlar
            }
            resizeCanvas(); // Her ÅŸeyin doÄŸru boyutlarda olduÄŸundan emin ol
            // YENÄ°: Sinema modunu ilk baÅŸta baÅŸlat
            handleUserActivity({clientX: window.innerWidth / 2, clientY: window.innerHeight / 2});
            // animateParticles(); // Ana dÃ¶ngÃ¼ zaten Ã§alÄ±ÅŸtÄ±rÄ±yor
        }, 500); // 500 milisaniye (yarÄ±m saniye) gecikme
    </script>
    <script>
        // YENÄ°: YÃ¼kleme ekranÄ± metinleri
        const loadingTexts = [
            "Frekanslar ayarlanÄ±yor...", "ParÃ§acÄ±klar birleÅŸtiriliyor...", "Cam parlatÄ±lÄ±yor...",
            "Renk paletleri oluÅŸturuluyor...", "Boyutlar arasÄ± geÃ§it aÃ§Ä±lÄ±yor...", "Ritme kilitleniliyor..."
        ];
        const loadingTextElement = document.getElementById('loading-text');
        let textInterval = setInterval(() => {
            const randomIndex = Math.floor(Math.random() * loadingTexts.length);
            loadingTextElement.textContent = loadingTexts[randomIndex];
        }, 1500);
        // YÃ¼kleme bitince interval'i durdur
        window.addEventListener('load', () => clearInterval(textInterval));
    </script>
</body>
</html>